<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue源码实现 | Vue源码解读</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/vue_source_code/img/logo.png">
    <meta name="description" content="Vue源码解读文档——静态资源站点">
    <meta name="keywords" content="VuePress静态资源站点模板">
    
    <link rel="preload" href="/vue_source_code/assets/css/0.styles.430e6bb9.css" as="style"><link rel="preload" href="/vue_source_code/assets/js/app.aa3d3475.js" as="script"><link rel="preload" href="/vue_source_code/assets/js/2.cbf47227.js" as="script"><link rel="preload" href="/vue_source_code/assets/js/1.59496952.js" as="script"><link rel="preload" href="/vue_source_code/assets/js/22.768a21f8.js" as="script"><link rel="prefetch" href="/vue_source_code/assets/js/10.28e329d8.js"><link rel="prefetch" href="/vue_source_code/assets/js/11.d55bfeeb.js"><link rel="prefetch" href="/vue_source_code/assets/js/12.b7c98e23.js"><link rel="prefetch" href="/vue_source_code/assets/js/13.19069418.js"><link rel="prefetch" href="/vue_source_code/assets/js/14.2960dbf0.js"><link rel="prefetch" href="/vue_source_code/assets/js/15.af4dfa65.js"><link rel="prefetch" href="/vue_source_code/assets/js/16.2b3fb98f.js"><link rel="prefetch" href="/vue_source_code/assets/js/17.67097fa9.js"><link rel="prefetch" href="/vue_source_code/assets/js/18.66dc6637.js"><link rel="prefetch" href="/vue_source_code/assets/js/19.28505e90.js"><link rel="prefetch" href="/vue_source_code/assets/js/20.37bf7ade.js"><link rel="prefetch" href="/vue_source_code/assets/js/21.d355680a.js"><link rel="prefetch" href="/vue_source_code/assets/js/23.8db598e9.js"><link rel="prefetch" href="/vue_source_code/assets/js/24.6a3afa2a.js"><link rel="prefetch" href="/vue_source_code/assets/js/25.c2ea773b.js"><link rel="prefetch" href="/vue_source_code/assets/js/26.b5502384.js"><link rel="prefetch" href="/vue_source_code/assets/js/27.b5c63e7b.js"><link rel="prefetch" href="/vue_source_code/assets/js/28.1c63e939.js"><link rel="prefetch" href="/vue_source_code/assets/js/29.3aa7bcfb.js"><link rel="prefetch" href="/vue_source_code/assets/js/3.44bcbd81.js"><link rel="prefetch" href="/vue_source_code/assets/js/30.7ccbf529.js"><link rel="prefetch" href="/vue_source_code/assets/js/31.35df0323.js"><link rel="prefetch" href="/vue_source_code/assets/js/32.a874bb8c.js"><link rel="prefetch" href="/vue_source_code/assets/js/33.36013a90.js"><link rel="prefetch" href="/vue_source_code/assets/js/34.ec3629db.js"><link rel="prefetch" href="/vue_source_code/assets/js/4.3a38be98.js"><link rel="prefetch" href="/vue_source_code/assets/js/5.02977365.js"><link rel="prefetch" href="/vue_source_code/assets/js/6.96e94ce4.js"><link rel="prefetch" href="/vue_source_code/assets/js/7.83e014ae.js"><link rel="prefetch" href="/vue_source_code/assets/js/vendors~docsearch.0644ee0a.js">
    <link rel="stylesheet" href="/vue_source_code/assets/css/0.styles.430e6bb9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vue_source_code/" class="home-link router-link-active"><img src="/vue_source_code/img/logo.png" alt="Vue源码解读" class="logo"> <span class="site-name can-hide">Vue源码解读</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vue_source_code/index.html" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="重要的源码" class="dropdown-title"><span class="title">重要的源码</span> <span class="arrow down"></span></button> <button type="button" aria-label="重要的源码" class="mobile-dropdown-title"><span class="title">重要的源码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue_source_code/important/reactivity.html" class="nav-link">
  响应式系统
</a></li><li class="dropdown-item"><!----> <a href="/vue_source_code/important/shared.html" class="nav-link">
  公共工具库
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前置知识" class="dropdown-title"><span class="title">前置知识</span> <span class="arrow down"></span></button> <button type="button" aria-label="前置知识" class="mobile-dropdown-title"><span class="title">前置知识</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue_source_code/front/Set.html" class="nav-link">
  Set、Map、WeakSet、WeakMap
</a></li><li class="dropdown-item"><!----> <a href="/vue_source_code/front/AST.html" class="nav-link">
  AST抽象语法树
</a></li><li class="dropdown-item"><!----> <a href="/vue_source_code/front/diff.html" class="nav-link">
  diff优化
</a></li><li class="dropdown-item"><!----> <a href="/vue_source_code/front/package.html" class="nav-link">
  package.json介绍
</a></li></ul></div></div> <a href="https://github.com/forfreeagainst/vue_source_code" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vue_source_code/index.html" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="重要的源码" class="dropdown-title"><span class="title">重要的源码</span> <span class="arrow down"></span></button> <button type="button" aria-label="重要的源码" class="mobile-dropdown-title"><span class="title">重要的源码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue_source_code/important/reactivity.html" class="nav-link">
  响应式系统
</a></li><li class="dropdown-item"><!----> <a href="/vue_source_code/important/shared.html" class="nav-link">
  公共工具库
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前置知识" class="dropdown-title"><span class="title">前置知识</span> <span class="arrow down"></span></button> <button type="button" aria-label="前置知识" class="mobile-dropdown-title"><span class="title">前置知识</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue_source_code/front/Set.html" class="nav-link">
  Set、Map、WeakSet、WeakMap
</a></li><li class="dropdown-item"><!----> <a href="/vue_source_code/front/AST.html" class="nav-link">
  AST抽象语法树
</a></li><li class="dropdown-item"><!----> <a href="/vue_source_code/front/diff.html" class="nav-link">
  diff优化
</a></li><li class="dropdown-item"><!----> <a href="/vue_source_code/front/package.html" class="nav-link">
  package.json介绍
</a></li></ul></div></div> <a href="https://github.com/forfreeagainst/vue_source_code" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>重要的源码</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue_source_code/important/reactivity.html" class="sidebar-link">响应式系统</a></li><li><a href="/vue_source_code/important/shared.html" class="sidebar-link">公共工具库</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前置知识</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue源码实现"><a href="#vue源码实现" class="header-anchor">#</a> Vue源码实现</h1> <p>npm install pnpm -g</p> <p>pnpm init</p> <p>当 shamefully-hoist 设置为 true 时，pnpm 会尝试模仿传统的 npm 和 yarn 行为，将所有依赖项都安装在项目的根 node_modules 文件夹中，而不是将它们分散到各个子文件夹中。 这通常是为了解决某些与路径解析或特定工具集成相关的问题。 然而，需要注意的是，使用 shamefully-hoist 可能会失去 pnpm 的主要优势之一，即节省磁盘空间。</p> <p>pnpm install vue@3.4.0 -w
-w根目录</p> <p>minimist 解析命令行参数</p> <p>pnpm install typescript esbuild minimist -D -w</p> <p>配制workspace （pnpm-workspace.yaml）
packages:</p> <ul><li>&quot;packages/*&quot;</li></ul> <p>pnpm tsc --init 或者npx tsc --init 找到node_modules的.bin下的tsc</p> <div class="language-md extra-class"><pre class="language-md"><code>{
  &quot;compilerOptions&quot;: {
    &quot;outDir&quot;: &quot;dist&quot;,//输出的目录
    &quot;sourceMap&quot;: true,//采用sourcemap
    &quot;target&quot;: &quot;es2016&quot;,//目标语法
    &quot;module&quot;: &quot;esnext&quot;,//模块格式
    &quot;moduleResolution&quot;: &quot;node&quot;,//模块解析方式
    &quot;strict&quot;: false,//严格模式
    &quot;resolveJsonModule&quot;: true,//解析json模块
    &quot;esModuleInterop&quot;: true,//允许通过es6语法引入commonjs模块
    &quot;jsx&quot;: &quot;preserve&quot;,//jsx 不转义
    &quot;lib&quot;: [&quot;esnext&quot;, &quot;dom&quot;] //支持的类库 esnext及dom
  }
}
</code></pre></div><p>不能在node环境使用esModule语法
package.json 添加 type: &quot;module&quot;</p> <div class="language-md extra-class"><pre class="language-md"><code>//以这个文件为基准，定义包的路径
&quot;baseUrl&quot;: &quot;.&quot;,
&quot;paths&quot;: {
  &quot;@vue/<span class="token italic"><span class="token punctuation">*</span><span class="token content">&quot;: [&quot;packages/</span><span class="token punctuation">*</span></span>/src&quot;]
}
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>加workspace不让它以为第三方的包
pnpm install @vue/shared --workspace --filter @vue/reactivity
</code></pre></div><p>reactivity :
不能被重复代用，已经代理过了
eg: 重复代用
const obj = {name:'durant', age: 35}
const state1 = reactive(obj);
const state2 = reactive(obj);
eg: 已经代理过了。需要重新理解
const song = {song:'进阶'};
const state1 = reactive(song);
const state2 = reactive(state1);</p> <p>Proxy, Reflect（调取对象的基本方法，receiver改变this指向）</p> <p>核心代码：effect类， 用于依赖收集，触发（页面）更新</p> <div class="language-md extra-class"><pre class="language-md"><code>effect(函数，选项)
effect的函数本身调用一遍。effect是一个类。
{
  active: 
  fn: effect中的函数
  scheduler: 
}

html:
activeEffect: 当前执行上下文的effect。
effect(() =&gt; {
  app.innerHTML = <span class="token code-snippet code keyword">`姓名${state.name}`</span>;
  effect(() =&gt; {
    state.name = 'durant123'
    app.innerHTML = <span class="token code-snippet code keyword">`姓名${state.name}`</span>;
  })
})
</code></pre></div><p>关键代码，依赖收集（让响应式属性和effect映射起来）</p> <div class="language-md extra-class"><pre class="language-md"><code>track: 一个大的WeackMap ，内含Map,又含Map
Map : {obj : {属性： Map: {effect, effect} } } 

effect自身调用，发现state.name/state.age, 进行依赖收集，
effect(() =&gt; {
  app.innerHTML = <span class="token code-snippet code keyword">`姓名${state.name} 年龄${state.age}`</span>;
})

// effect，才会被数据收集，trigger发现被收集了，触发更新。（数据变化了，触发更新/调用trigger）
setTimeout(() =&gt; {
  state.age = 999;
})
</code></pre></div><p>effect的延伸：不同条件依赖不同（重新收集依赖）,存在相同依赖， 依赖减少了</p> <div class="language-md extra-class"><pre class="language-md"><code>// {obj: { flag: {effect}, {name: {effect} } }
// {obj: { flag: {effect}, {age: {effect} } }

effect(() =&gt; {
  app.innerHTML = state.flag ? state.name + state.name: state.age;
})
setTimeout(() =&gt; {
  state.flag = false;
  setTimeout(() =&gt; {
    state.name = 'james';//这里需要effect
  }, 1000)
}, 1000)

// {flag,name}
// {flag,age}
简易diff算法

_trackId 用于记录执行次数，防止一个属性在当前effect中多次依赖收集

// {flag,name,age,year}
// {flag}
</code></pre></div><p>effect的选项options</p> <p>scheduler调用run,想晚点调用run(AOP编程/面向切面编程，在原有的逻辑，增加自己的逻辑)</p> <div class="language-md extra-class"><pre class="language-md"><code>let runner = effect(
  () =&gt; {
    app.innerHTML = state.flag ? state.name : state.age;
  },
  {
    scheduler: () =&gt; {
      console.log(&quot;数据更新了，不直接渲染，走一下自己的逻辑先&quot;);
      runner(); //重新渲染
    }
  }
)
</code></pre></div><p>effect的优化：防止递归，深度代理</p> <div class="language-md extra-class"><pre class="language-md"><code>//防止递归
effect(() =&gt; {
  app.innerHTML = state.name;
  state.name = Math.random();//更新了数据，不要再执行effect了。effect加个_running正在执行的逻辑
})
//深度代理
effect(() =&gt; {
  state.info.address = '北京天安门';
})
</code></pre></div><p>ref</p> <div class="language-md extra-class"><pre class="language-md"><code>const flag = ref(false); //wrap,包了一层，因为对象在访问属性的时候，可以进行拦截
effect(() =&gt; {
  app.innerHTML = flag.value;
})
let flag1 : {
  _value: false,
  set() {},
  get() {}
}

class RefImpl {
  __v_isRef = true;//增加ref标识
  _value; //用来保存ref的值
  constructor(public rawValue) {} //public会在实例上增加一个属性
  set() {}
  get() {}
}
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/vue_source_code/assets/js/app.aa3d3475.js" defer></script><script src="/vue_source_code/assets/js/2.cbf47227.js" defer></script><script src="/vue_source_code/assets/js/1.59496952.js" defer></script><script src="/vue_source_code/assets/js/22.768a21f8.js" defer></script>
  </body>
</html>
